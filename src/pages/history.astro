---
import PrefetchLinks from "@/components/PrefetchLinks.astro";
import Button from "@/components/ui/Button.astro";
import TopBar from "@/components/ui/TopBar.astro";
import PageLayout from "@/layouts/PageLayout.astro";
import { HomeViewAnimation } from "@/utils/ViewAnimation";
---

<PageLayout
	title="WhiteboardScanner - Verlauf"
	pageID="historyPage"
	viewAnimation={HomeViewAnimation}
>
	<TopBar>
		<a onclick="history.back()" style="margin-left: auto">
			<i class="fa-solid fa-xmark closeBtn"></i>
		</a>
	</TopBar>
	<h1>
		<i class="fa-solid fa-clock-rotate-left"></i>Verlauf
	</h1>
	<ul id="pushShareList">
		<!-- <p>Dienstag, 18.11.2025</p>
		<li>
			<div>
				<p><span>PhiMai</span> hat dir einen PushShare gesendet</p>
				<span id="fileName">
					<i class="fa-regular fa-clock"></i>17:36 Uhr <b>•</b><i
						class="fa-solid fa-image"
					>
					</i>IMG_0543455434.png
				</span>
			</div>
			<img src="/bertie.jpg" />
		</li>
		<li class="sent">
			<div>
				<p>Du hast einen PushShare an <span>PhiMai</span> gesendet</p>
				<span id="fileName">
					<i class="fa-regular fa-clock"></i>17:36 Uhr <b>•</b><i
						class="fa-solid fa-image"
					>
					</i>IMG_0543455434.png
				</span>
			</div>
			<img src="/bertie.jpg" />
		</li> -->
	</ul>
</PageLayout>

<style lang="scss" is:global>
	html:has(#historyPage) {
		//overflow-y: auto;
		//height: fit-content !important;
	}
	#historyPage {
		//height: fit-content !important;
		//max-height: unset !important;
		padding-top: 2.5rem !important;

		h1 {
			display: flex;
			justify-content: center;
			align-items: center;
			gap: 0.5rem;
			//margin-bottom: 3rem;
			font-size: 2.5rem;
			width: 100%;
			//margin-bottom: 0.5rem;

			//margin-top: -0.5rem;

			> i {
				font-size: 2rem;
			}
		}

		ul {
			display: flex;
			flex-direction: column;
			gap: 1.5rem;

			list-style: none;

			> p {
				margin-top: 1.5rem;
				color: darken(white, 30%);
				margin-inline: auto;
				border: 1px solid darken(white, 30%);
				padding: 0.25rem 0.5rem;
				border-radius: 0.5rem;
				font-size: 1rem;
			}

			> p.old {
				color: darken(white, 30%);
				/* font-size: 1rem;
			display: flex;
			align-items: center;
			gap: 0.25rem; */

				&:not(:first-of-type) {
					margin-top: 1.5rem;
				}

				flex-shrink: 0;

				display: flex;
				align-items: center;
				white-space: nowrap;
				gap: 1rem;

				&::before,
				&::after {
					content: "";
					position: relative;
					width: 100%;
					height: 1px;

					flex-shrink: 1;

					//background-color: darken(white, 50%) !important;
					border-radius: 9999rem;
				}

				&::before {
					background: linear-gradient(
						90deg,
						transparent,
						darken(white, 50%) 50%
					);
				}

				&::after {
					background: linear-gradient(
						90deg,
						darken(white, 50%) 50%,
						transparent
					);
				}
			}

			li {
				position: relative;
				font-size: 1.5rem;

				padding: 1.25rem 1.5rem;

				width: fit-content;
				//width: 0px;
				height: fit-content;

				background-color: #151718;
				border-radius: 1rem;

				display: flex;
				flex-direction: column;
				gap: 1rem;

				overflow: hidden;

				&.sent {
					background-color: white;
					color: black;
					margin-left: auto;

					> div > span {
						color: darken(white, 60%);
					}

					> a {
						justify-content: flex-end;
					}
				}

				> div {
					font-size: 1.25rem;
					width: fit-content;

					p {
						//margin-bottom: -0.25rem;
						> span {
							color: orange;
						}
					}

					> span {
						color: darken(white, 30%);
						font-size: 1rem;
						display: flex;
						align-items: center;
						gap: 0.25rem;
						overflow: hidden;

						b {
							font-weight: 900;
							margin-inline: 0.15rem;
						}

						&#date {
							font-size: 1.25rem;

							margin-bottom: 0.25rem;

							i {
								font-size: 1.25rem;
							}
						}

						&#fileName {
							//margin-bottom: 1rem;
						}
					}
				}

				> a {
					position: relative;
					width: 100%;
					height: fit-content;

					display: flex;
					align-items: flex-start;
					justify-content: flex-start;

					container-type: inline-size;

					> img {
						//position: absolute;
						//width: min(100%, 30rem);
						//max-height: 100%;
						//width: min(100%, 30rem);
						width: auto;
						max-width: min(30rem, 100cqw);
						max-height: 20rem;
						//max-width: 100%;
						object-fit: contain;
						cursor: pointer;

						overflow: hidden;

						border-radius: 0.5rem;
					}
				}
			}
		}
	}
</style>

<script>
	import { storedDeviceUUID } from "@/stores/store";
	import { createInitSwapFunction } from "@/utils/InitSwapFunction";

	type SentPushShareType = {
		fileName: string;
		pushshare_uuid: string;
		receivers: Array<{
			uuid: string;
			name: string;
		}>;
		sender_uuid: string;
		timestamp: string;
		uploading: boolean;
	};

	type RecievedPushShareType = {
		fileName: string;
		pushshare_uuid: string;
		sender_uuid: string;
		sender_name: string;
		timestamp: string;
		uploading: boolean;
	};

	function isSentPushShare(
		pushshare: SentPushShareType | RecievedPushShareType,
	): pushshare is SentPushShareType {
		return (pushshare as SentPushShareType).receivers !== undefined;
	}

	createInitSwapFunction(() => {
		const pushShareList = document.getElementById("pushShareList");
		if (!pushShareList) return;

		const device_uuid = storedDeviceUUID.get();

		window.sendSocketRequest(
			{
				id: "GET_HISTORY",
				device_uuid: storedDeviceUUID.get(),
			},
			(response: {
				id: "GET_HISTORY_RES";
				sent_pushshares: Array<SentPushShareType>;
				recieved_pushshares: Array<RecievedPushShareType>;
			}) => {
				console.log(response);

				const allPushShares = [
					...response.recieved_pushshares,
					...response.sent_pushshares,
				].sort((a, b) => {
					return (
						new Date(b.timestamp).getTime() -
						new Date(a.timestamp).getTime()
					);
				});

				let lastDate: null | Date = null;
				for (const pushshare of allPushShares) {
					const date = new Date(pushshare.timestamp);

					const isSameDay = (date1: Date, date2: Date) => {
						return date1.toDateString() === date2.toDateString();
					};

					if (lastDate === null || !isSameDay(lastDate, date)) {
						lastDate = date;

						const formattedDate = date.toLocaleDateString("de-DE", {
							weekday: "long", // "Dienstag"
							day: "2-digit", // "18"
							month: "2-digit", // "11"
							year: "numeric", // "2025"
						});

						pushShareList.insertAdjacentHTML(
							"beforeend",
							`<p>${formattedDate}</p>`,
						);
					}

					if (isSentPushShare(pushshare)) {
						// SENT
						pushShareList.insertAdjacentHTML(
							"beforeend",
							`<li class="sent">
                                <div>
                                    <p>Du hast einen PushShare an <span id="reciever_names_${pushshare.pushshare_uuid}"></span> gesendet</p>
                                    <span>
                                        <i class="fa-regular fa-clock"></i><span id="time_${pushshare.pushshare_uuid}"></span> Uhr <b>•</b><i
                                            class="fa-solid fa-image"
                                        ></i><span id="fileName_${pushshare.pushshare_uuid}"></span>
                                    </span>
                                </div>
                                <a href="/push-share?uuid=${encodeURIComponent(pushshare.pushshare_uuid)}">
                                    <img src="https://api.astrowhiteboardscanner.zorrle001.dev/push-share/${pushshare.pushshare_uuid}/${device_uuid}" loading="lazy"/>
                                </a>
                            </li>`,
						);

						const recieverNamesEl = document.getElementById(
							`reciever_names_${pushshare.pushshare_uuid}`,
						);
						const timeEl = document.getElementById(
							`time_${pushshare.pushshare_uuid}`,
						);
						const fileNameEl = document.getElementById(
							`fileName_${pushshare.pushshare_uuid}`,
						);

						if (!recieverNamesEl || !timeEl || !fileNameEl) return;

						let recievers = [];
						for (let recv of pushshare.receivers) {
							recievers.push(recv.name);
						}

						recieverNamesEl.innerText = recievers.join(", ");
						timeEl.innerText = date.toLocaleTimeString("de-DE", {
							hour: "2-digit",
							minute: "2-digit",
						});
						fileNameEl.innerText = pushshare.fileName;
					} else {
						// RECIEVED
						pushShareList.insertAdjacentHTML(
							"beforeend",
							`<li>
                                <div>
                                    <p><span id="sender_name_${pushshare.pushshare_uuid}"></span> hat dir einen PushShare gesendet</p>
                                    <span>
                                        <i class="fa-regular fa-clock"></i><span id="time_${pushshare.pushshare_uuid}"></span> Uhr <b>•</b><i
                                            class="fa-solid fa-image"
                                        ></i><span id="fileName_${pushshare.pushshare_uuid}"></span>
                                    </span>
                                </div>
                                <a href="/push-share?uuid=${encodeURIComponent(pushshare.pushshare_uuid)}">
                                    <img src="https://api.astrowhiteboardscanner.zorrle001.dev/push-share/${pushshare.pushshare_uuid}/${device_uuid}" loading="lazy"/>
                                </a>
                            </li>`,
						);

						const senderNameEl = document.getElementById(
							`sender_name_${pushshare.pushshare_uuid}`,
						);
						const timeEl = document.getElementById(
							`time_${pushshare.pushshare_uuid}`,
						);
						const fileNameEl = document.getElementById(
							`fileName_${pushshare.pushshare_uuid}`,
						);

						if (!senderNameEl || !timeEl || !fileNameEl) return;

						senderNameEl.innerText = pushshare.sender_name;
						timeEl.innerText = date.toLocaleTimeString("de-DE", {
							hour: "2-digit",
							minute: "2-digit",
						});
						fileNameEl.innerText = pushshare.fileName;
					}
				}
			},
		);
	}, "/history");
</script>
